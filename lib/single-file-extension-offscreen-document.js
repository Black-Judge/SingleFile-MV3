!function(){"use strict";"undefined"==typeof globalThis&&(window.globalThis=window),(()=>{if(!globalThis.browser&&globalThis.chrome){const e=globalThis.chrome;globalThis.__defineGetter__("browser",(()=>({action:{onClicked:{addListener:t=>e.action.onClicked.addListener(t)},setBadgeText:t=>e.action.setBadgeText(t),setBadgeBackgroundColor:t=>e.action.setBadgeBackgroundColor(t),setTitle:t=>e.action.setTitle(t),setIcon:t=>e.action.setIcon(t)},bookmarks:{get:t=>e.bookmarks.get(t),onCreated:{addListener:t=>e.bookmarks.onCreated.addListener(t),removeListener:t=>e.bookmarks.onCreated.removeListener(t)},onChanged:{addListener:t=>e.bookmarks.onChanged.addListener(t),removeListener:t=>e.bookmarks.onChanged.removeListener(t)},onMoved:{addListener:t=>e.bookmarks.onMoved.addListener(t),removeListener:t=>e.bookmarks.onMoved.removeListener(t)},update:(t,n)=>e.bookmarks.update(t,n)},commands:{onCommand:{addListener:t=>e.commands.onCommand.addListener(t)}},downloads:{download:t=>e.downloads.download(t),onChanged:{addListener:t=>e.downloads.onChanged.addListener(t),removeListener:t=>e.downloads.onChanged.removeListener(t)},search:t=>e.downloads.search(t)},i18n:{getMessage:(t,n)=>e.i18n.getMessage(t,n)},identity:{getRedirectURL:()=>e.identity.getRedirectURL(),getAuthToken:t=>e.identity.getAuthToken(t),launchWebAuthFlow:t=>e.identity.launchWebAuthFlow(t),removeCachedAuthToken:t=>e.identity.removeCachedAuthToken(t)},contextMenus:{onClicked:{addListener:t=>e.contextMenus.onClicked.addListener(t)},create:t=>e.contextMenus.create(t),update:(t,n)=>e.contextMenus.update(t,n),removeAll:()=>e.contextMenus.removeAll()},permissions:{request:t=>e.permissions.request(t),remove:t=>e.permissions.remove(t)},runtime:{id:e.runtime.id,sendNativeMessage:(t,n)=>new Promise(((r,a)=>{e.runtime.sendNativeMessage(t,n,(t=>{e.runtime.lastError?a(e.runtime.lastError):r(t)}))})),getManifest:()=>e.runtime.getManifest(),onMessage:{addListener:t=>e.runtime.onMessage.addListener(((e,n,r)=>{const a=t(e,n);if(a&&"function"==typeof a.then)return a.then((e=>{if(void 0!==e)try{r(e)}catch(e){}})),!0})),removeListener:t=>e.runtime.onMessage.removeListener(t)},onMessageExternal:{addListener:t=>e.runtime.onMessageExternal.addListener(((e,n,r)=>{const a=t(e,n);if(a&&"function"==typeof a.then)return a.then((e=>{if(void 0!==e)try{r(e)}catch(e){}})),!0}))},sendMessage:t=>new Promise(((n,r)=>{e.runtime.sendMessage(t,(t=>{e.runtime.lastError?r(e.runtime.lastError):n(t)})),e.runtime.lastError&&r(e.runtime.lastError)})),getURL:t=>e.runtime.getURL(t),getContexts:t=>e.runtime.getContexts(t),get lastError(){return e.runtime.lastError}},scripting:{executeScript:t=>e.scripting.executeScript(t)},storage:{local:{set:t=>e.storage.local.set(t),get:t=>e.storage.local.get(t),clear:()=>e.storage.local.clear(),remove:t=>e.storage.local.remove(t)},sync:{set:t=>e.storage.sync.set(t),get:t=>e.storage.sync.get(t),clear:()=>e.storage.sync.clear(),remove:t=>e.storage.sync.remove(t)}},tabs:{onCreated:{addListener:t=>e.tabs.onCreated.addListener(t)},onActivated:{addListener:t=>e.tabs.onActivated.addListener(t)},onUpdated:{addListener:t=>e.tabs.onUpdated.addListener(t),removeListener:t=>e.tabs.onUpdated.removeListener(t)},onRemoved:{addListener:t=>e.tabs.onRemoved.addListener(t),removeListener:t=>e.tabs.onRemoved.removeListener(t)},onReplaced:{addListener:t=>e.tabs.onReplaced.addListener(t),removeListener:t=>e.tabs.onReplaced.removeListener(t)},captureVisibleTab:(t,n)=>e.tabs.captureVisibleTab(t,n),sendMessage:(t,n,r={})=>new Promise(((a,o)=>{e.tabs.sendMessage(t,n,r,(t=>{e.runtime.lastError?o(e.runtime.lastError):a(t)})),e.runtime.lastError&&o(e.runtime.lastError)})),query:t=>e.tabs.query(t),create:t=>e.tabs.create(t),get:t=>e.tabs.get(t),remove:t=>e.tabs.remove(t),update:(t,n)=>e.tabs.update(t,n)},devtools:{inspectedWindow:{onResourceContentCommitted:{addListener:t=>e.devtools.inspectedWindow.onResourceContentCommitted.addListener(t)},get tabId(){return e.devtools.inspectedWindow.tabId}}},offscreen:{createDocument:t=>e.offscreen.createDocument(t)},declarativeNetRequest:{updateSessionRules:t=>e.declarativeNetRequest.updateSessionRules(t)}})))}})();const e="single-file-request-fetch-supported",t="single-file-response-fetch-supported",n="single-file-request-fetch",r="single-file-response-fetch",a="Host fetch error (SingleFile)",o=Boolean(window.wrappedJSObject),s=(e,t)=>window.fetch(e,t);let i,c=0,u=new Map;async function f(d,l={},m=!0){try{const c={cache:l.cache||"force-cache",headers:l.headers,referrerPolicy:l.referrerPolicy||"strict-origin-when-cross-origin"};let u;try{u=l.referrer&&!o||!m?await s(d,c):await async function(o,s){if(void 0===i&&(i=!1,document.addEventListener(t,(()=>i=!0),!1),document.dispatchEvent(new CustomEvent(e))),i)return new Promise(((e,t)=>{document.dispatchEvent(new CustomEvent(n,{detail:JSON.stringify({url:o,options:s})})),document.addEventListener(r,(function n(a){a.detail?a.detail.url==o&&(document.removeEventListener(r,n,!1),a.detail.response?e({status:a.detail.status,headers:new Map(a.detail.headers),arrayBuffer:async()=>a.detail.response}):t(a.detail.error)):t()}),!1)}));throw new Error(a)}(d,c),401!=u.status&&403!=u.status&&404!=u.status||"no-referrer"!=c.referrerPolicy&&(u=await f(d,{...c,referrerPolicy:"no-referrer"},m))}catch(e){if(e&&e.message==a)u=await f(d,{...c},!1);else{if("no-referrer"==c.referrerPolicy)throw e;u=await f(d,{...c,referrerPolicy:"no-referrer"},m)}}return u}catch(e){c++;const t=new Promise(((e,t)=>u.set(c,{resolve:e,reject:t})));return await w({method:"singlefile.fetch",url:d,requestId:c,referrer:l.referrer,headers:l.headers}),t}}async function d(e,t){const n=await w({method:"singlefile.fetchFrame",url:e,frameId:t.frameId,referrer:t.referrer,headers:t.headers});return{status:n.status,headers:new Map(n.headers),arrayBuffer:async()=>new Uint8Array(n.array).buffer}}async function w(e){const t=await browser.runtime.sendMessage(e);if(!t||t.error)throw new Error(t&&t.error&&t.error.toString());return t}browser.runtime.onMessage.addListener((e=>"singlefile.fetchFrame"==e.method&&window.frameId&&window.frameId==e.frameId?async function(e){try{const t=await s(e.url,{cache:"force-cache",headers:e.headers,referrerPolicy:"strict-origin-when-cross-origin"});return{status:t.status,headers:[...t.headers],array:Array.from(new Uint8Array(await t.arrayBuffer()))}}catch(e){return{error:e&&e.toString()}}}(e):"singlefile.fetchResponse"==e.method?async function(e){const t=u.get(e.requestId);t&&(e.error?(t.reject(new Error(e.error)),u.delete(e.requestId)):(e.truncated&&(t.array?t.array=t.array.concat(e.array):(t.array=e.array,u.set(e.requestId,t)),e.finished&&(e.array=t.array)),e.truncated&&!e.finished||(t.resolve({status:e.status,headers:{get:t=>e.headers&&e.headers[t]},arrayBuffer:async()=>new Uint8Array(e.array).buffer}),u.delete(e.requestId))));return{}}(e):void 0));const l=0,m=[l],y=Symbol(),h=new TextEncoder,g=new TextDecoder,b=new Array(256);let p=0;function v(e,t,n,r){if(void 0===r){if(p++,!(b.length-p>=m.length))throw new Error("Reached maximum number of custom types");b[b.length-p]={serialize:e,parse:t,test:n}}else b[r]={serialize:e,parse:t,test:n}}async function L(e,t){const n=b.findIndex((({test:n}={})=>n&&n(t,e)));e.addObject(t),await e.append(new Uint8Array([n]));const r=b[n].serialize;r&&await r(e,t),n!=l&&N(t)&&(await async function(e,t){const n=Object.getOwnPropertySymbols(t),r=n.map((e=>[e,t[e]]));await A(e,r)}(e,t),await async function(e,t){if(ArrayBuffer.isView(t))await L(e,0);else{let n=Object.entries(t);D(t)&&(n=n.filter((([e])=>!z(Number(e))))),await L(e,n.length);for(const[t,r]of n)await U(e,t),await L(e,r)}}(e,t))}async function A(e,t){await L(e,t.length);const n=Object.keys(t).filter((e=>z(Number(e)))).map((e=>Number(e)));let r=0,a=n[r];for(const[o,s]of t.entries())a==o?(a=n[++r],await L(e,s)):await L(e,y)}async function U(e,t){const n=h.encode(t);await L(e,n.length),await e.append(n)}async function E(e,t){await L(e,t.length),await e.append("Uint8Array"==t.constructor.name?t:new Uint8Array(t.buffer))}async function R(e,t){const n=new Uint8Array(new Float64Array([t]).buffer);await e.append(n)}async function C(e,t){const n=new Uint8Array([Number(t)]);await e.append(n)}v((async function(e,t){const n=e.objects.indexOf(t);await L(e,n)}),(async function(e){const t=await O(e);return new I(t,e)}),(function(e,t){return N(e)&&t.objects.includes(e)}),l),v(null,(function(){return{}}),N),v(A,x,D),v(U,T,(function(e){return"string"==typeof e})),v(E,(async function(e){const t=await O(e),n=await e.consume(8*t);return new Float64Array(n.buffer)}),(function(e){return"Float64Array"==e.constructor.name})),v(E,(async function(e){const t=await O(e),n=await e.consume(4*t);return new Float32Array(n.buffer)}),(function(e){return"Float32Array"==e.constructor.name})),v(E,(async function(e){const t=await O(e),n=await e.consume(4*t);return new Uint32Array(n.buffer)}),(function(e){return"Uint32Array"==e.constructor.name})),v(E,(async function(e){const t=await O(e),n=await e.consume(4*t);return new Int32Array(n.buffer)}),(function(e){return"Int32Array"==e.constructor.name})),v(E,(async function(e){const t=await O(e),n=await e.consume(2*t);return new Uint16Array(n.buffer)}),(function(e){return"Uint16Array"==e.constructor.name})),v(E,(async function(e){const t=await O(e),n=await e.consume(2*t);return new Int16Array(n.buffer)}),(function(e){return"Int16Array"==e.constructor.name})),v(E,(async function(e){const t=await O(e),n=await e.consume(t);return new Uint8ClampedArray(n.buffer)}),(function(e){return"Uint8ClampedArray"==e.constructor.name})),v(E,(async function(e){const t=await O(e);return await e.consume(t)}),(function(e){return"Uint8Array"==e.constructor.name})),v(E,(async function(e){const t=await O(e),n=await e.consume(t);return new Int8Array(n.buffer)}),(function(e){return"Int8Array"==e.constructor.name})),v((async function(e,t){await L(e,t.byteLength),await e.append(new Uint8Array(t))}),(async function(e){const t=await O(e);return(await e.consume(t)).buffer}),(function(e){return"ArrayBuffer"==e.constructor.name})),v(R,B,F),v((async function(e,t){const n=new Uint8Array(new Uint32Array([t]).buffer);await e.append(n)}),(async function(e){const t=await e.consume(4);return new Uint32Array(t.buffer)[0]}),(function(e){return z(e)&&e>=0&&e<=4294967295})),v((async function(e,t){const n=new Uint8Array(new Int32Array([t]).buffer);await e.append(n)}),(async function(e){const t=await e.consume(4);return new Int32Array(t.buffer)[0]}),(function(e){return z(e)&&e>=-2147483648&&e<=2147483647})),v((async function(e,t){const n=new Uint8Array(new Uint16Array([t]).buffer);await e.append(n)}),(async function(e){const t=await e.consume(2);return new Uint16Array(t.buffer)[0]}),(function(e){return z(e)&&e>=0&&e<=65535})),v((async function(e,t){const n=new Uint8Array(new Int16Array([t]).buffer);await e.append(n)}),(async function(e){const t=await e.consume(2);return new Int16Array(t.buffer)[0]}),(function(e){return z(e)&&e>=-32768&&e<=32767})),v((async function(e,t){const n=new Uint8Array([t]);await e.append(n)}),(async function(e){const t=await e.consume(1);return new Uint8Array(t.buffer)[0]}),(function(e){return z(e)&&e>=0&&e<=255})),v((async function(e,t){const n=new Uint8Array(new Int8Array([t]).buffer);await e.append(n)}),(async function(e){const t=await e.consume(1);return new Int8Array(t.buffer)[0]}),(function(e){return z(e)&&e>=-128&&e<=127})),v(null,(function(){return}),(function(e){return void 0===e})),v(null,(function(){return null}),(function(e){return null===e})),v(null,(function(){return NaN}),(function(e){return Number.isNaN(e)})),v(C,P,(function(e){return"boolean"==typeof e})),v((async function(e,t){await U(e,t.description)}),(async function(e){const t=await T(e);return Symbol(t)}),H),v(null,(function(){return y}),q),v((async function(e,t){const n=t.entries();await L(e,t.size);for(const[t,r]of n)await L(e,t),await L(e,r)}),(async function(e){const t=await O(e),n=new Map;t&&await async function r(a=0){const o=await O(e),s=await O(e);e.setObject([o,s],((e,t)=>n.set(e,t))),a<t-1&&await r(a+1)}();return n}),(function(e){return e instanceof Map})),v((async function(e,t){await L(e,t.size);for(const n of t)await L(e,n)}),(async function(e){const t=await O(e),n=new Set;t&&await async function r(a=0){const o=await O(e);e.setObject([o],(e=>n.add(e))),a<t-1&&await r(a+1)}();return n}),(function(e){return e instanceof Set})),v((async function(e,t){await R(e,t.getTime())}),(async function(e){const t=await B(e);return new Date(t)}),(function(e){return e instanceof Date})),v((async function(e,t){await U(e,t.message),await U(e,t.stack)}),(async function(e){const t=await T(e),n=await T(e),r=new Error(t);return r.stack=n,r}),(function(e){return e instanceof Error})),v((async function(e,t){await U(e,t.source),await U(e,t.flags)}),(async function(e){const t=await T(e),n=await T(e);return new RegExp(t,n)}),(function(e){return e instanceof RegExp})),v((async function(e,t){await U(e,t.valueOf())}),(async function(e){return new String(await T(e))}),(function(e){return e instanceof String})),v((async function(e,t){await R(e,t.valueOf())}),(async function(e){return new Number(await B(e))}),(function(e){return e instanceof Number})),v((async function(e,t){await C(e,t.valueOf())}),(async function(e){return new Boolean(await P(e))}),(function(e){return e instanceof Boolean}));class I{constructor(e,t){this.index=e,this.data=t}getObject(){return this.data.objects[this.index]}}class j{constructor(e){this.stream=new M(e),this.objects=[],this.setters=[]}consume(e){return this.stream.consume(e)}getObjectId(){const e=this.objects.length;return this.objects.push(void 0),e}resolveObject(e,t){(function(e){return N(e)||H(e)})(t)&&!S(t)&&(this.objects[e]=t)}setObject(e,t){this.setters.push({functionArguments:e,setterFunction:t})}executeSetters(){this.setters.forEach((({functionArguments:e,setterFunction:t})=>{t(...e.map((e=>S(e)?e.getObject():e)))}))}}class M{constructor(e){this.offset=0,this.value=new Uint8Array(0),this.consumeData=e}async consume(e){if(this.offset+e>this.value.length){const t=new Uint8Array(this.value).subarray(this.offset,this.value.length),n=await this.consumeData();return t.length+n.length!=this.value.length&&(this.value=new Uint8Array(t.length+n.length)),this.value.set(t),this.value.set(n,t.length),this.offset=0,this.consume(e)}{const t=this.value.slice(this.offset,this.offset+e);return this.offset+=t.length,t}}}function k(){let e,t,n,r,a,o;return{next:async t=>t?async function(t){a?await a:async function(){let t;r=new Promise((e=>t=e)),e=new j(i),s();const n=await O(e);e.executeSetters(),t(n)}().catch((()=>{}));return function(){a=new Promise((e=>o=e))}(),n(t),{done:!1}}(t):{value:await r,done:!0},return:()=>({done:!0})};function s(){t=new Promise((e=>n=e))}async function i(){const e=await t;return s(),o&&o(),e}}async function O(e){const t=(await e.consume(1))[0],n=b[t].parse,r=e.getObjectId(),a=await n(e);return t!=l&&N(a)&&(await async function(e,t){const n=await x(e);e.setObject([n],(e=>e.forEach((([e,n])=>t[e]=n))))}(e,a),await async function(e,t){const n=await O(e);n&&await r();async function r(a=0){const o=await T(e),s=await O(e);e.setObject([s],(e=>t[o]=e)),a<n-1&&await r(a+1)}}(e,a)),e.resolveObject(r,a),a}async function x(e){const t=await O(e),n=new Array(t);return t&&await async function r(a=0){const o=await O(e);q(o)||e.setObject([o],(e=>n[a]=e));a<t-1&&await r(a+1)}(),n}async function T(e){const t=await O(e),n=await e.consume(t);return g.decode(n)}async function B(e){const t=await e.consume(8);return new Float64Array(t.buffer)[0]}async function P(e){const t=await e.consume(1);return Boolean(t[0])}function S(e){return e instanceof I}function N(e){return e===Object(e)}function D(e){return"number"==typeof e.length}function q(e){return e===y}function F(e){return"number"==typeof e}function z(e){return F(e)&&Number.isInteger(e)}function H(e){return"symbol"==typeof e}const W=new Map;function _(e,t={}){return new Promise(((n,r)=>{const a=new XMLHttpRequest;if(a.withCredentials=!0,a.responseType="arraybuffer",a.onerror=e=>r(new Error(e.detail)),a.onreadystatechange=()=>{a.readyState==XMLHttpRequest.DONE&&n({status:a.status,headers:{get:e=>a.getResponseHeader(e)},arrayBuffer:async()=>a.response})},a.open("GET",e,!0),t.headers)for(const e of Object.entries(t.headers))a.setRequestHeader(e[0],e[1]);a.send()}))}browser.runtime.onMessage.addListener((async({method:e,pageData:t,url:n,data:r,mimeType:a,options:o,width:s,height:i,tabId:c})=>{if("processPage"==e){const e=await function(e,t,n,r={fetch:f,frameFetch:d}){return globalThis.singlefile.getPageData(e,r,t,n)}(o,null,null,{fetch:_}),t=new Blob(["string"==typeof e.content?e.content:new Uint8Array(e.content)],{type:e.mimeType});return{url:URL.createObjectURL(t),archiveTime:e.archiveTime,doctype:e.doctype,filename:e.filename,title:e.title}}if("compressPage"==e){let e=W.get(c);if(e||(e=k(),W.set(c,e)),r)return await e.next(new Uint8Array(r)),{};{const t=await e.next();W.delete(c);const n=t.value,r=await function(e,t){return globalThis.singlefile.processors.compression.process(e,t)}(n,o);return URL.createObjectURL(r)}}if("getBlobURL"==e){const e={};return a&&(e.type=a),URL.createObjectURL(new Blob([new Uint8Array(r)],e))}if("revokeObjectURL"==e)return URL.revokeObjectURL(n),{};if("getImageData"==e){const e=new Image;await new Promise(((t,r)=>{e.onload=t,e.onerror=e=>r(new Error(e.detail)),e.src=n}));const t=document.createElement("canvas");t.width=s,t.height=i;const r=t.getContext("2d");r.drawImage(e,0,0,s,i);const{data:a}=await r.getImageData(0,0,s,i);return{url:URL.createObjectURL(new Blob([a]))}}return"saveToClipboard"==e?(function(e){const t="copy";function n(t){t.clipboardData.setData(e.mimeType,e.content),t.clipboardData.setData("text/plain",e.content),t.preventDefault()}document.addEventListener(t,n),document.execCommand(t),document.removeEventListener(t,n)}(t),{}):void 0}))}();
