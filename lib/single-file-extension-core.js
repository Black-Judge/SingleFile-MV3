!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).extension={})}(this,(function(e){"use strict";const r="single-file-request-fetch-supported",t="single-file-response-fetch-supported",a="single-file-request-fetch",s="single-file-response-fetch",n="Host fetch error (SingleFile)",i=Boolean(window.wrappedJSObject),o=(e,r)=>window.fetch(e,r);let c,f=0,d=new Map;async function u(e,l,y=!0){try{const f={cache:l.cache||"force-cache",headers:l.headers,referrerPolicy:l.referrerPolicy||"strict-origin-when-cross-origin"};let d;try{d=l.referrer&&!i||!y?await o(e,f):await async function(e,i){if(void 0===c&&(c=!1,document.addEventListener(t,(()=>c=!0),!1),document.dispatchEvent(new CustomEvent(r))),c)return new Promise(((r,t)=>{document.dispatchEvent(new CustomEvent(a,{detail:JSON.stringify({url:e,options:i})})),document.addEventListener(s,(function a(n){n.detail?n.detail.url==e&&(document.removeEventListener(s,a,!1),n.detail.response?r({status:n.detail.status,headers:new Map(n.detail.headers),arrayBuffer:async()=>n.detail.response}):t(n.detail.error)):t()}),!1)}));throw new Error(n)}(e,f),401!=d.status&&403!=d.status&&404!=d.status||"no-referrer"!=f.referrerPolicy&&(d=await u(e,{...f,referrerPolicy:"no-referrer"},y))}catch(r){if(r&&r.message==n)d=await u(e,{...f},!1);else{if("no-referrer"==f.referrerPolicy)throw r;d=await u(e,{...f,referrerPolicy:"no-referrer"},y)}}return d}catch(r){f++;const t=new Promise(((e,r)=>d.set(f,{resolve:e,reject:r})));return await h({method:"singlefile.fetch",url:e,requestId:f,referrer:l.referrer,headers:l.headers}),t}}async function l(e,r){const t=await h({method:"singlefile.fetchFrame",url:e,frameId:r.frameId,referrer:r.referrer,headers:r.headers});return{status:t.status,headers:new Map(t.headers),arrayBuffer:async()=>new Uint8Array(t.array).buffer}}async function h(e){const r=await browser.runtime.sendMessage(e);if(!r||r.error)throw new Error(r&&r.error&&r.error.toString());return r}browser.runtime.onMessage.addListener((e=>"singlefile.fetchFrame"==e.method&&window.frameId&&window.frameId==e.frameId?async function(e){try{const r=await o(e.url,{cache:"force-cache",headers:e.headers,referrerPolicy:"strict-origin-when-cross-origin"});return{status:r.status,headers:[...r.headers],array:Array.from(new Uint8Array(await r.arrayBuffer()))}}catch(e){return{error:e&&e.toString()}}}(e):"singlefile.fetchResponse"==e.method?async function(e){const r=d.get(e.requestId);r&&(e.error?(r.reject(new Error(e.error)),d.delete(e.requestId)):(e.truncated&&(r.array?r.array=r.array.concat(e.array):(r.array=e.array,d.set(e.requestId,r)),e.finished&&(e.array=r.array)),e.truncated&&!e.finished||(r.resolve({status:e.status,headers:{get:r=>e.headers&&e.headers[r]},arrayBuffer:async()=>new Uint8Array(e.array).buffer}),d.delete(e.requestId))));return{}}(e):void 0)),e.compress=function(e,r){return globalThis.singlefile.processors.compression.process(e,r)},e.getPageData=function(e,r,t,a={fetch:u,frameFetch:l}){return globalThis.singlefile.getPageData(e,a,r,t)}}));
