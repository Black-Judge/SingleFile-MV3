!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).extension={})}(this,(function(e){"use strict";const r="single-file-request-fetch",t="single-file-ack-fetch",a="single-file-response-fetch",n="Host fetch error (SingleFile)",s=2500,o=Boolean(window.wrappedJSObject),i=(e,r)=>window.fetch(e,r);let c=0,f=new Map;async function d(e,d={}){try{const c={cache:"force-cache",headers:d.headers,referrerPolicy:"strict-origin-when-cross-origin"};let f;try{f=d.referrer&&!o?await i(e,c):await async function(e,o){const c=new Promise(((i,c)=>{document.dispatchEvent(new CustomEvent(r,{detail:JSON.stringify({url:e,options:o})})),document.addEventListener(t,u,!1),document.addEventListener(a,d,!1);const f=setTimeout((()=>{l(),c(new Error(n))}),s);function d(r){r.detail?r.detail.url==e&&(l(),r.detail.response?i({status:r.detail.status,headers:new Map(r.detail.headers),arrayBuffer:async()=>r.detail.response}):c(r.detail.error)):c()}function u(){clearTimeout(f)}function l(){document.removeEventListener(a,d,!1),document.removeEventListener(t,u,!1)}}));try{return await c}catch(r){if(r&&r.message==n)return i(e,o);throw r}}(e,c)}catch(r){if(!r||r.message!=n)throw r;f=await i(e,c)}return f}catch(r){c++;const t=new Promise(((e,r)=>f.set(c,{resolve:e,reject:r})));return await l({method:"singlefile.fetch",url:e,requestId:c,referrer:d.referrer,headers:d.headers}),t}}async function u(e,r){const t=await l({method:"singlefile.fetchFrame",url:e,frameId:r.frameId,referrer:r.referrer,headers:r.headers});return{status:t.status,headers:new Map(t.headers),arrayBuffer:async()=>new Uint8Array(t.array).buffer}}async function l(e){const r=await browser.runtime.sendMessage(e);if(!r||r.error)throw new Error(r&&r.error&&r.error.toString());return r}browser.runtime.onMessage.addListener((e=>"singlefile.fetchFrame"==e.method&&window.frameId&&window.frameId==e.frameId?async function(e){try{const r=await i(e.url,{cache:"force-cache",headers:e.headers});return{status:r.status,headers:[...r.headers],array:Array.from(new Uint8Array(await r.arrayBuffer()))}}catch(e){return{error:e&&e.toString()}}}(e):"singlefile.fetchResponse"==e.method?async function(e){const r=f.get(e.requestId);r&&(e.error?(r.reject(new Error(e.error)),f.delete(e.requestId)):(e.truncated&&(r.array?r.array=r.array.concat(e.array):(r.array=e.array,f.set(e.requestId,r)),e.finished&&(e.array=r.array)),e.truncated&&!e.finished||(r.resolve({status:e.status,headers:{get:r=>e.headers&&e.headers[r]},arrayBuffer:async()=>new Uint8Array(e.array).buffer}),f.delete(e.requestId))));return{}}(e):void 0)),e.compress=function(e,r){return globalThis.singlefile.processors.compression.process(e,r)},e.getPageData=function(e,r,t,a={fetch:d,frameFetch:u}){return globalThis.singlefile.getPageData(e,a,r,t)},Object.defineProperty(e,"__esModule",{value:!0})}));
